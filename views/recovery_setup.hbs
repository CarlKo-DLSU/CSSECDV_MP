<div id="recovery-setup-container" class="page-center">
    <h1>Complete account setup</h1>

    <p>You're registering as: <strong>{{username}}</strong></p>
    <p>Please choose one recovery question and provide an answer. The answer will be normalized and stored hashed — keep it something only you know.</p>

    <form id="recovery-setup-form" method="POST" action="/auth/recovery_setup">
        <label for="reco-question">Recovery question</label>
        <select id="reco-question" name="question" required>
            <option value="">-- Select a question --</option>
            <option value="What is the name of a childhood friend that no one else would know?">What is the name of a childhood friend that no one else would know?</option>
            <option value="What is your favorite fictional location from a book or movie?">What is your favorite fictional location from a book or movie?</option>
            <option value="What is/was the name of your first pet?">What is/was the name of your first pet?</option>
        </select>

        <label for="reco-answer">Answer</label>
        <input id="reco-answer" name="answer" type="text" placeholder="Type your answer here" autocomplete="off" required>

        <div class="form-actions">
            <button type="submit" class="btn primary">Complete Registration</button>
            <a href="/" class="btn link">Cancel</a>
        </div>

        <p id="reco-error" class="form-error" aria-live="polite"></p>
    </form>

    <script>
        (function () {
            const form = document.getElementById('recovery-setup-form')
            const question = document.getElementById('reco-question')
            const answer = document.getElementById('reco-answer')
            const errEl = document.getElementById('reco-error')

            if (!form) return

            form.addEventListener('submit', async (e) => {
                e.preventDefault()
                errEl.textContent = ''

                const qVal = question.value
                const aVal = (answer.value || '').trim()

                if (!qVal) {
                    errEl.textContent = 'Please select a recovery question.'
                    question.focus()
                    return
                }
                if (!aVal) {
                    errEl.textContent = 'Please provide an answer.'
                    answer.focus()
                    return
                }

                // Submit via fetch so server can respond with JSON or redirect
                try {
                    const res = await fetch(form.action, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                        credentials: 'same-origin',
                        body: JSON.stringify({ question: qVal, answer: aVal })
                    })

                    if (res.ok) {
                        const data = await res.json().catch(() => ({}))
                        if (data && data.redirect) {
                            window.location.href = data.redirect
                            return
                        }
                        window.location.href = '/'
                        return
                    }

                    // display server-provided message if available
                    const text = await res.text().catch(() => '')
                    if (text) {
                        errEl.textContent = text
                    } else {
                        errEl.textContent = 'Failed to complete registration. Try again.'
                    }
                } catch (err) {
                    errEl.textContent = 'Network error — try again.'
                }
            })
        })();
    </script>
</div>