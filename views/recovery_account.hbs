<div class="page-center">
    <h1>Account Recovery</h1>

    <div id="recovery-verify">
        <p>Enter your username, pick the recovery question, and provide the answer.</p>

        <form id="verify-form" action="/auth/recovery_account/verify" method="POST">
            <label>Username
                <input type="text" name="username" id="ra-username" required>
            </label>
            <br/>
            <label>Recovery question
                <select id="ra-question" name="question" required>
                    <option value="">-- Select a question --</option>
                    <option value="What is the name of a childhood friend that no one else would know?">What is the name of a childhood friend that no one else would know?</option>
                    <option value="What is your favorite fictional location from a book or movie?">What is your favorite fictional location from a book or movie?</option>
                    <option value="What is/was the name of your first pet?">What is/was the name of your first pet?</option>
                </select>
            </label>
            <br/>
            <label>Answer
                <input type="text" id="ra-answer" name="answer" autocomplete="off" required>
            </label>

            <div style="margin-top:12px;">
                <button type="submit" class="popup-button hov1">Verify</button>
                <a href="/" class="popup-button link">Cancel</a>
            </div>

            <p id="ra-verify-msg" class="form-error" aria-live="polite"></p>
        </form>
    </div>

    <div id="recovery-reset" style="display:none; margin-top:20px;">
        <h3>Change Password</h3>
        <p>You may now set a new password for this account.</p>
        <form id="reset-form" action="/auth/recovery_account/reset" method="POST">
            <label>New Password
                <input type="password" id="ra-new-password" name="new_password" required>
            </label>
            <br/>
            <label>Confirm New Password
                <input type="password" id="ra-confirm-password" name="confirm_password" required>
            </label>
            <div style="margin-top:12px;">
                <button type="submit" class="popup-button hov1">Change Password</button>
                <a href="/" class="popup-button link">Cancel</a>
            </div>
            <p id="ra-reset-msg" class="form-error" aria-live="polite"></p>
        </form>
    </div>
</div>

<script>
(function(){
    const verifyForm = document.getElementById('verify-form')
    const raUsername = document.getElementById('ra-username')
    const raQuestion = document.getElementById('ra-question')
    const raAnswer = document.getElementById('ra-answer')
    const verifyMsg = document.getElementById('ra-verify-msg')

    const resetSection = document.getElementById('recovery-reset')
    const resetForm = document.getElementById('reset-form')
    const newPwd = document.getElementById('ra-new-password')
    const confPwd = document.getElementById('ra-confirm-password')
    const resetMsg = document.getElementById('ra-reset-msg')

    verifyForm && verifyForm.addEventListener('submit', async (e) => {
        e.preventDefault()
        verifyMsg.textContent = ''
        const payload = {
            username: raUsername.value.trim(),
            question: raQuestion.value,
            answer: raAnswer.value.trim()
        }
        try {
            const res = await fetch(verifyForm.action, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify(payload)
            })
            const data = await res.json().catch(() => ({}))
            if (res.ok && data.verified) {
                // show reset form
                resetSection.style.display = 'block'
                // scroll to reset
                resetSection.scrollIntoView({ behavior: 'smooth' })
                verifyMsg.textContent = 'Verified. You may now set a new password.'
                verifyMsg.style.color = 'green'
                return
            }
            verifyMsg.textContent = data.error || 'Verification failed.'
        } catch (err) {
            verifyMsg.textContent = 'Network error — try again.'
        }
    })

    resetForm && resetForm.addEventListener('submit', async (e) => {
        e.preventDefault()
        resetMsg.textContent = ''

        if (newPwd.value !== confPwd.value) {
            resetMsg.textContent = 'Passwords do not match.'
            return
        }

        try {
            const res = await fetch(resetForm.action, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify({ new_password: newPwd.value, confirm_password: confPwd.value })
            })
            const data = await res.json().catch(() => ({}))
            if (res.ok && data.success) {
                // success -> redirect or inform
                window.location.href = data.redirect || '/'
                return
            }
            resetMsg.textContent = data.error || 'Failed to change password.'
        } catch (err) {
            resetMsg.textContent = 'Network error — try again.'
        }
    })
})();
</script>